<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>mmg-wasm Cube Remeshing Example</title>
  <link rel="stylesheet" href="../styles.css">
  <style>
    /* Override max-width for simpler single-purpose layout */
    body { max-width: 600px; }
  </style>
</head>
<body>
  <h1>mmg-wasm Cube Remeshing</h1>
  <p class="subtitle">Remesh a unit cube with adjustable mesh density</p>

  <div id="status" class="status loading">Loading WASM module...</div>

  <div class="controls">
    <div class="slider-group">
      <label for="hmax">Maximum edge length (hmax)</label>
      <input type="range" id="hmax" min="0.1" max="1.0" step="0.05" value="0.3">
      <div class="slider-value">hmax = <span id="hmaxValue">0.3</span></div>
    </div>
    <button id="remeshBtn" disabled>Remesh</button>
  </div>

  <div class="results">
    <h2>Mesh Statistics</h2>
    <table>
      <thead>
        <tr>
          <th>Metric</th>
          <th>Before</th>
          <th>After</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Vertices</td>
          <td id="verticesBefore">-</td>
          <td id="verticesAfter">-</td>
        </tr>
        <tr>
          <td>Tetrahedra</td>
          <td id="tetraBefore">-</td>
          <td id="tetraAfter">-</td>
        </tr>
        <tr>
          <td>Triangles</td>
          <td id="triBefore">-</td>
          <td id="triAfter">-</td>
        </tr>
      </tbody>
    </table>
  </div>

  <script type="module">
    import {
      cubeVertices,
      cubeTetrahedra,
      cubeTriangles,
      nVertices,
      nTetrahedra,
      nTriangles
    } from './cube.js';

    // DPARAM.hmax index from mmg3d.ts
    const DPARAM_HMAX = 28;
    // IPARAM.verbose index
    const IPARAM_VERBOSE = 0;

    let Module = null;

    // DOM elements
    const statusEl = document.getElementById('status');
    const hmaxSlider = document.getElementById('hmax');
    const hmaxValueEl = document.getElementById('hmaxValue');
    const remeshBtn = document.getElementById('remeshBtn');

    // Update slider display
    hmaxSlider.addEventListener('input', () => {
      hmaxValueEl.textContent = hmaxSlider.value;
    });

    // Load WASM module
    // Uses relative path - works both locally (with copied build) and on GitHub Pages
    async function initModule() {
      try {
        const createModule = (await import('./mmg.js')).default;
        Module = await createModule();
        statusEl.textContent = 'Ready to remesh';
        statusEl.className = 'status success';
        remeshBtn.disabled = false;
      } catch (err) {
        statusEl.textContent = `Failed to load WASM module. Run 'bun run build' first, then 'bun run example'.`;
        statusEl.className = 'status error';
        console.error('WASM load error:', err);
      }
    }

    // Remesh function
    async function remesh() {
      if (!Module) return;

      const hmax = parseFloat(hmaxSlider.value);
      remeshBtn.disabled = true;
      statusEl.textContent = 'Remeshing...';
      statusEl.className = 'status loading';

      // Show initial stats
      document.getElementById('verticesBefore').textContent = nVertices;
      document.getElementById('tetraBefore').textContent = nTetrahedra;
      document.getElementById('triBefore').textContent = nTriangles;
      document.getElementById('verticesAfter').textContent = '-';
      document.getElementById('tetraAfter').textContent = '-';
      document.getElementById('triAfter').textContent = '-';

      // Use requestAnimationFrame to allow UI update
      await new Promise(r => requestAnimationFrame(r));

      try {
        // Initialize mesh
        const handle = Module._mmg3d_init();
        if (handle < 0) {
          throw new Error('Failed to initialize mesh');
        }

        try {
          // Set mesh size
          let result = Module._mmg3d_set_mesh_size(
            handle,
            nVertices,
            nTetrahedra,
            0, // nPrisms
            nTriangles,
            0, // nQuads
            0  // nEdges
          );
          if (result !== 1) throw new Error('Failed to set mesh size');

          // Set vertices
          const verticesPtr = Module._malloc(cubeVertices.byteLength);
          Module.HEAPF64.set(cubeVertices, verticesPtr / 8);
          result = Module._mmg3d_set_vertices(handle, verticesPtr, 0);
          Module._free(verticesPtr);
          if (result !== 1) throw new Error('Failed to set vertices');

          // Set tetrahedra
          const tetraPtr = Module._malloc(cubeTetrahedra.byteLength);
          Module.HEAP32.set(cubeTetrahedra, tetraPtr / 4);
          result = Module._mmg3d_set_tetrahedra(handle, tetraPtr, 0);
          Module._free(tetraPtr);
          if (result !== 1) throw new Error('Failed to set tetrahedra');

          // Set triangles
          const triPtr = Module._malloc(cubeTriangles.byteLength);
          Module.HEAP32.set(cubeTriangles, triPtr / 4);
          result = Module._mmg3d_set_triangles(handle, triPtr, 0);
          Module._free(triPtr);
          if (result !== 1) throw new Error('Failed to set triangles');

          // Set parameters
          Module._mmg3d_set_iparameter(handle, IPARAM_VERBOSE, -1); // Quiet
          Module._mmg3d_set_dparameter(handle, DPARAM_HMAX, hmax);

          // Run remeshing
          result = Module._mmg3d_remesh(handle);
          if (result !== 0) {
            console.warn(`Remeshing returned code ${result}`);
          }

          // Get output mesh size
          const sizePtr = Module._malloc(6 * 4);
          Module._mmg3d_get_mesh_size(
            handle,
            sizePtr,      // np
            sizePtr + 4,  // ne
            sizePtr + 8,  // nprism
            sizePtr + 12, // nt
            sizePtr + 16, // nquad
            sizePtr + 20  // na
          );

          const newVertices = Module.getValue(sizePtr, 'i32');
          const newTetra = Module.getValue(sizePtr + 4, 'i32');
          const newTri = Module.getValue(sizePtr + 12, 'i32');
          Module._free(sizePtr);

          // Update UI with results
          document.getElementById('verticesAfter').textContent = newVertices;
          document.getElementById('tetraAfter').textContent = newTetra;
          document.getElementById('triAfter').textContent = newTri;

          statusEl.textContent = `Remeshing complete (hmax=${hmax})`;
          statusEl.className = 'status success';

        } finally {
          // Clean up
          Module._mmg3d_free(handle);
        }

      } catch (err) {
        statusEl.textContent = `Error: ${err.message}`;
        statusEl.className = 'status error';
        console.error(err);
      }

      remeshBtn.disabled = false;
    }

    // Event listeners
    remeshBtn.addEventListener('click', remesh);

    // Initialize
    initModule();
  </script>
</body>
</html>
